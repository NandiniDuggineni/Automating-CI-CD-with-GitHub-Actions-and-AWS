name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
        chmod 400 ec2_key.pem

    - name: Deploy to EC2
      run: |
        scp -i ec2_key.pem -o StrictHostKeyChecking=no -r ./app ec2-user@<EC2_PUBLIC_IP>:/home/ec2-user/app
        ssh -i ec2_key.pem -o StrictHostKeyChecking=no ec2-user@<EC2_PUBLIC_IP> "bash /home/ec2-user/app/scripts/deploy.sh"

    - name: Send SNS notification
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws sns publish \
          --topic-arn arn:aws:sns:us-east-1:<ACCOUNT_ID>:deploy-topic \
          --message "âœ… Deployment to EC2 successful!"
